<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>개요: 아르카니스 마법학교</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_8Gmarket@1.0/GmarketSansMedium.woff2" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'GmarketSansMedium';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_8Gmarket@1.0/GmarketSansMedium.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'GmarketSansMedium', sans-serif; font-size: 16px; height: 100vh; display: flex; overflow: hidden; }
    nav { width: 280px; background: #f5f5f5; padding: 20px; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; }
    nav h2 { font-size: 18px; margin-bottom: 20px; }
    nav a { font-size: 13px; font-weight: bold; display: block; margin-bottom: 10px; color: black; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .container { flex-grow: 1; display: flex; overflow: hidden; }
    .map-area { width: 60%; min-width: 200px; max-width: 90%; background: white; display: flex; justify-content: center; align-items: center; overflow: auto; padding: 20px; transition: width 0.2s; }
    #mapImage { max-width: 1200px; width: 100%; height: auto; object-fit: contain; }
    .resizer { width: 5px; background: #ccc; cursor: col-resize; }
    .pdf-area { flex-grow: 1; background: #ffffff; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; align-items: center; border-left: 1px solid #ddd; scroll-behavior: smooth; transition: width 0.2s; }
    canvas { margin: 0; padding: 0; border: none; display: block; width: 100%; height: auto; }
  </style>
</head>
<body>

<nav>
  <h2>에버론 : 아르카니스 마법학교</h2>
  <a href="?page=ep1.pdf&map=ep1">[EP1] 아지 긴 시간표</a>
  <a href="?page=ep2.pdf&map=ep2">[EP2] 첫번째 수업</a>
  <a href="?page=ep3.pdf&map=ep3">[EP3] 순수한 피</a>
  <a href="?page=ep4.pdf&map=ep4">[EP4] 두번째 날 수업</a>
</nav>

<div class="container">
  <div class="map-area">
    <img src="./maps/ep1/map1.png" alt="맵 이미지가 여기 표시됩니다" id="mapImage">
  </div>
  <div class="resizer" id="resizer"></div>
  <div class="pdf-area" id="content">
    <h1>PDF 로딩 중...</h1>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const page = urlParams.get('page') || 'ep1.pdf';
const mapFolder = urlParams.get('map') || 'ep1';
const pdfUrl = `./pdfs/${page}`;
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
const content = document.getElementById('content');
const mapImage = document.getElementById('mapImage');
content.innerHTML = '';

function getMapImage(pageNumber) {
  // 여기에 ep1~ep4 맵 분기 입력 (생략)
  return `./maps/${mapFolder}/map1.png`;
}

const loadingTask = pdfjsLib.getDocument(pdfUrl);
loadingTask.promise.then(function(pdf) {
  content.innerHTML = '';
  let pageNumber = 1;
  function renderPage(num) {
    pdf.getPage(num).then(function(page) {
      let scale = 2.0;
      if (mapFolder === 'ep1' && (num >= 16 && num <= 20)) scale = 1.5;
      if (mapFolder === 'ep3' && (num >= 125 && num <= 127)) scale = 1.5;
      const viewport = page.getViewport({ scale: scale });
      const canvas = document.createElement('canvas');
      canvas.dataset.pageNumber = num;
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      const renderContext = { canvasContext: context, viewport: viewport };
      page.render(renderContext);
      content.appendChild(canvas);
      if (num < pdf.numPages) setTimeout(() => renderPage(num + 1), 0);
    });
  }
  renderPage(pageNumber);
});

function updateCurrentMapByScroll() {
  const canvases = document.querySelectorAll('.pdf-area canvas');
  let closestCanvas = null;
  let minDistance = Infinity;
  const viewportCenter = window.innerHeight / 2;

  canvases.forEach(canvas => {
    const rect = canvas.getBoundingClientRect();
    const canvasCenter = rect.top + rect.height / 2;
    const distance = Math.abs(viewportCenter - canvasCenter);
    if (distance < minDistance) {
      minDistance = distance;
      closestCanvas = canvas;
    }
  });

  if (closestCanvas) {
    const currentPage = parseInt(closestCanvas.dataset.pageNumber, 10);
    const newSrc = getMapImage(currentPage);
    const currentSrc = mapImage.src.replace(window.location.origin + '/', './');
    if (currentSrc !== newSrc) {
      mapImage.src = newSrc;
    }
  }
}

document.querySelector('.pdf-area').addEventListener('scroll', updateCurrentMapByScroll);

const resizer = document.getElementById('resizer');
const mapArea = document.querySelector('.map-area');
let isResizing = false;
resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  const containerRect = document.querySelector('.container').getBoundingClientRect();
  let newMapWidth = e.clientX - containerRect.left;
  let totalWidth = containerRect.width;
  if (newMapWidth < 200) newMapWidth = 200;
  if (newMapWidth > totalWidth - 200) newMapWidth = totalWidth - 200;
  mapArea.style.width = newMapWidth + 'px';
});
document.addEventListener('mouseup', () => { if (isResizing) { isResizing = false; document.body.style.cursor = 'default'; } });
window.addEventListener('load', () => {
  const containerRect = document.querySelector('.container').getBoundingClientRect();
  mapArea.style.width = (containerRect.width - 200) + 'px';
});
</script>

</body>
</html>
